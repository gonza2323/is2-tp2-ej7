<!DOCTYPE html>
<html class="no-js" lang="zxx"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/adminLayout}">

<head>
    <title>Gimnasio Sport - Mis cuotas</title>
</head>

<body>

<th:block layout:fragment="content">
    <section class="my-5">
        <div class="container">

            <div th:if="${msgError}" th:text="#{${msgError}}" class="alert alert-danger" role="alert">MENSAJE ERROR</div>
            <div th:if="${msgExito}" th:text="${msgExito}" class="alert alert-success" role="alert">MENSAJE ÉXITO</div>
            <div th:if="${msg}" th:text="${msg}" class="alert alert-info" role="alert">MENSAJE NEUTRO</div>

            <div class="d-flex align-items-center mb-3 flex-wrap">
                <h3 class="m-0 mr-3">Mis cuotas</h3>
            </div>

            <div class="container mb-3">
                <div class="row">
                    <div class="col-md-4 m-0 px-0 d-flex align-items-center">
                        <h4 th:if="${deudaTotal > 0}" class="text-danger m-0">
                            Deuda total: <span th:text="${#numbers.formatCurrency(deudaTotal)}">Monto</span>
                        </h4>
                        <h4 th:if="${deudaTotal == 0}" class="m-0">Usted no posee deuda</h4>
                    </div>
                    <div class="col-md-8 m-0 px-0">
                        <div class="d-flex align-items-center justify-content-md-end justify-content-between"
                             th:if="${deudaTotal > 0}">
                            <div class="mr-3">Total a pagar: <span id="totalAPagar">Monto</span></div>
                            <form th:action="@{/cuotas/pagar}" method="post" style="display:inline" id="formularioPago"
                                  th:onsubmit="'return confirm(\'Está seguro de qué desea pagar las cuotas seleccionadas?\')'">
                                <button type="submit" class="genric-btn primary radius" id="botonPago">
                                    Pagar cuotas seleccionadas
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Año</th>
                        <th>Mes</th>
                        <th>Fecha de vencimiento</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th style="text-align: center"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="cuota : ${cuotas}">
                        <td th:text="${cuota.anio}">Año</td>
                        <td th:text="${cuota.mes}">Mes</td>
                        <td th:text="${cuota.fechaVencimiento}">Fecha de vencimiento</td>
                        <td th:text="${#numbers.formatCurrency(cuota.monto)}">Monto</td>
                        <td th:text="${cuota.estado}">Estado</td>
                        <td style="vertical-align: middle;" class="text-center">
                            <div class="primary-checkbox cuota-checkbox" style="margin: 0 auto; height: 20px; width: 20px; background: #a5a5a5; border-radius: 8px;"
                                 th:if="${cuota.estado.name() == 'ADEUDADA'}">
                                <input type="checkbox" name="cuotasSeleccionadas" th:value="${cuota.id}"
                                       th:id="${cuota.id}" form="formularioPago"
                                       th:attr="data-monto=${cuota.monto}">
                                <label th:for="${cuota.id}" class="m-0"></label>
                            </div>
                            <a th:if="${cuota.estado.name() == 'PAGADA'}"
                               th:href="@{/cuotas/{id}/factura(id=${cuota.id})}"
                               class="btn btn-info">Ver Factura</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            const form = document.getElementById('formularioPago');
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="cuotasSeleccionadas"]');
            const submitBtn = document.getElementById('botonPago');
            const totalSpan = document.getElementById('totalAPagar');

            function updateSubmitState() {
                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                submitBtn.disabled = !anyChecked;

                if (anyChecked) {
                    submitBtn.classList.add('primary');
                    submitBtn.classList.remove('disable');
                } else {
                    submitBtn.classList.add('disable');
                    submitBtn.classList.remove('primary');
                }
            }

            function updateTotal() {
                let total = 0;
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        total += parseFloat(cb.dataset.monto);
                    }
                });

                totalSpan.textContent = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(total);
            }

            function handleChange() {
                updateSubmitState();
                updateTotal();
            }

            checkboxes.forEach(cb => cb.addEventListener('change', handleChange));

            handleChange();
        </script>
    </section>

</th:block>

</body>
</html>